---
- name: Get geonode-project from repo
  git:
    repo: https://github.com/GeoNode/geonode-project.git
    dest: ~/geonode-project

- name: Install Django in virtualenv
  pip:
    virtualenv: ~/.virtualenvs/{{ project | lower }}
    name: Django=={{ django_version }}

- name: Create project
  shell: |
    source ~/.bashrc && source ~/.virtualenvs/{{ project | lower }}/bin/activate &&
    django-admin startproject --template=./geonode-project -e py,rst,json,yml,ini,env,sample -n Dockerfile {{ project | lower }}
  args:
    creates: "~/{{ project | lower }}"
    executable: /bin/bash

- name: Install Geonode from requirements
  pip:
    virtualenv: ~/.virtualenvs/{{ project | lower }}
    requirements: requirements.txt
    state: latest
  args:
    chdir: ~/{{ project | lower }}

- name: Install Geonode
  pip:
    virtualenv: ~/.virtualenvs/{{ project | lower }}
    name: .
    state: latest
    extra_args: -e
  args:
    chdir: ~/{{ project | lower }}

- include_tasks: install_pygdal.yml

- name: Copy local_settings sample
  command: cp {{ project | lower }}/local_settings.py.sample {{ project | lower }}/local_settings.py
  args:
    chdir: ~/{{ project | lower }}
    creates: ~/{{ project | lower }}/{{ project | lower }}/local_settings.py

- name: Patch GeoLite2 database install
  include_tasks: patch_4154.yml

- name: Restart Django
  file:
    path: ~/{{ project | lower }}//{{ project | lower }}/wsgi.py
    state:  touch

- name: Paver commands
  shell: |
    source ~/.bashrc && source ~/.virtualenvs/{{ project | lower }}/bin/activate &&
    paver {{ item }}
  args:
    executable: /bin/bash
    chdir: ~/{{ project | lower }}
  with_items:
    - reset
    - setup
    - sync
    - start
